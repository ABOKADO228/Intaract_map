<!DOCTYPE html>
<html>
<head>
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ - CartoDB Voyager</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="assets/leaflet/leaflet.css" />
    <style>
        #web-content {
            display: flex;
            width: 100%;
            height: 97vh;
            justify-self: center;
            align-self: center;
        }
        #map {
            width: 75%;
            height: 100%;
        }
        #side-panel {
            width: 25%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        .nav-tree-container {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .point-info-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background-color: #fff;
            flex-grow: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .color-controls {
            margin-top: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .color-picker {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .color-picker label {
            margin-right: 10px;
            font-weight: bold;
            font-size: 14px;
        }
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }
        #nav-tree {
            list-style-type: none;
            padding: 0;
            margin: 10px 0 0 0;
            max-height: 300px;
            overflow-y: auto;
        }
        #nav-tree li {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #4361ee;
            transition: all 0.2s;
        }
        #nav-tree li:hover {
            background-color: #edf2ff;
        }
        #nav-tree li.selected {
            background-color: #e6f0ff;
            border-left: 3px solid #2d4fc7;
        }
        .marker-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
            flex-shrink: 0;
        }
        .marker-info {
            flex-grow: 1;
            cursor: pointer;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex-shrink: 0;
            margin-left: 5px;
        }
        .delete-btn:hover {
            background: #ff3742;
        }
        .empty {
            color: #777;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }
        h3 {
            margin-bottom: 12px;
            color: #333;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        h3 i {
            margin-right: 8px;
            color: #4361ee;
        }
        #point-info {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
        }
        #point-info p {
            margin: 8px 0;
            line-height: 1.4;
        }
        #apply-color {
            margin-top: 10px;
            padding: 8px 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }
        #apply-color:hover {
            background: #3a56d4;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
        .search-container {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .search-btn {
            width: 100%;
            padding: 8px 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .search-btn:hover {
            background: #3a56d4;
        }
        .search-results {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
        }
        .search-result-item:hover {
            background-color: #f0f0f0;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é */
        .visibility-controls {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .visibility-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .visibility-btn {
            padding: 8px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .visibility-btn i {
            margin-right: 5px;
        }
        .visibility-btn:hover {
            background: #5a6268;
        }
        .visibility-btn.hide {
            background: #ff4757;
        }
        .visibility-btn.hide:hover {
            background: #ff3742;
        }
        .visibility-btn.show {
            background: #2ed573;
        }
        .visibility-btn.show:hover {
            background: #27c466;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ */
        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .group-title {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .group-title i {
            margin-right: 8px;
            transition: transform 0.3s;
        }
        .group-toggle {
            color: #777;
            font-size: 12px;
        }
        .group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .group-content.expanded {
            max-height: 500px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ */
        .selected-points-container {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .selected-points-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
        }
        .selected-point-item {
            display: flex;
            align-items: center;
            padding: 6px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #4361ee;
        }
        .selected-point-item:last-child {
            margin-bottom: 0;
        }
        .selected-point-name {
            flex-grow: 1;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .remove-selected-btn {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 5px;
        }
        .remove-selected-btn:hover {
            color: #ff3742;
        }
        .selection-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .selection-btn {
            padding: 8px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .selection-btn:hover {
            background: #5a6268;
        }
        .selection-btn.select {
            background: #4361ee;
        }
        .selection-btn.select:hover {
            background: #3a56d4;
        }
        .selection-btn.deselect {
            background: #ff4757;
        }
        .selection-btn.deselect:hover {
            background: #ff3742;
        }

        /* –ò–∫–æ–Ω–∫–∏ */
        .icon-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: 4px;
        }
        .icon-btn:hover {
            color: #4361ee;
            background-color: #f0f0f0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª */
        .file-link {
            color: #4361ee;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 5px;
        }
        .file-link:hover {
            color: #3a56d4;
        }
        .file-info {
            margin-top: 5px;
            font-size: 13px;
            color: #666;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ */
        .files-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
        }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #4361ee;
        }
        .file-item:last-child {
            margin-bottom: 0;
        }
        .file-name {
            flex-grow: 1;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-count {
            background-color: #4361ee;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞ */
        .offline-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            border: 2px solid #ddd;
            font-weight: bold;
        }
        .offline-status.online {
            color: #2ed573;
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }
        .offline-status.offline {
            color: #ff4757;
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞–º–∏ */
        .mode-controls {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .mode-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .mode-btn.offline {
            background: #4361ee;
            color: white;
        }
        .mode-btn.online {
            background: #2ed573;
            color: white;
        }
        .mode-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div id="web-content">
        <div id="map">
            <div id="offline-status" class="offline-status offline">
                ‚óã CartoDB Voyager - –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
            </div>
            <div class="mode-controls">
                <button class="mode-btn offline" onclick="switchToOfflineLayer()">
                    ‚óã –û—Ñ–ª–∞–π–Ω
                </button>
                <button class="mode-btn online" onclick="switchToOnlineLayer()">
                    ‚óè –û–Ω–ª–∞–π–Ω
                </button>
            </div>
        </div>
        <div id="side-panel">
            <div class="search-container">
                <h3>üîç –ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫</h3>
                <input type="text" id="search-input" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ...">
                <button id="search-btn" class="search-btn">–ü–æ–∏—Å–∫</button>
                <div id="search-results" class="search-results" style="display: none;"></div>
            </div>

            <div class="visibility-controls">
                <h3>üëÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é</h3>
                <div class="visibility-buttons">
                    <button id="hide-all-btn" class="visibility-btn hide">üëÅ –°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
                    <button id="show-all-btn" class="visibility-btn show">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                    <button id="hide-selected-btn" class="visibility-btn hide">üëÅ –°–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                    <button id="show-selected-btn" class="visibility-btn show">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                </div>
            </div>

            <div class="selected-points-container">
                <h3>‚úì –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h3>
                <div id="selected-points-list" class="selected-points-list">
                    <div class="empty">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫</div>
                </div>
                <div class="selection-controls">
                    <button id="select-all-btn" class="selection-btn select">‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button id="deselect-all-btn" class="selection-btn deselect">‚úó –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
                </div>
            </div>

            <div class="nav-tree-container">
                <div class="group-header" id="nav-tree-header">
                    <div class="group-title">
                        üìÅ
                        <span>–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞</span>
                    </div>
                    <div class="group-toggle">
                        <button class="icon-btn" id="toggle-nav-tree">
                            ‚ñº
                        </button>
                    </div>
                </div>
                <div class="group-content" id="nav-tree-content">
                    <ul id="nav-tree">
                        <li class="empty">–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–µ—Ä–µ–≤–∞</li>
                    </ul>
                </div>
            </div>

            <div class="color-controls">
                <h3>üé® –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–≤</h3>
                <div class="color-picker">
                    <label for="marker-color">–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞:</label>
                    <input type="color" id="marker-color" value="#4361ee">
                </div>
                <div class="color-options">
                    <div class="color-option selected" style="background-color: #4361ee;" data-color="#4361ee"></div>
                    <div class="color-option" style="background-color: #ff4757;" data-color="#ff4757"></div>
                    <div class="color-option" style="background-color: #2ed573;" data-color="#2ed573"></div>
                    <div class="color-option" style="background-color: #ffa502;" data-color="#ffa502"></div>
                    <div class="color-option" style="background-color: #a55eea;" data-color="#a55eea"></div>
                    <div class="color-option" style="background-color: #00d2d3;" data-color="#00d2d3"></div>
                </div>
                <button id="apply-color">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –º–∞—Ä–∫–µ—Ä–∞–º</button>
            </div>

            <div class="point-info-container">
                <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ</h3>
                <div id="point-info">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ</div>
            </div>
        </div>
    </div>

    <script src="assets/leaflet/leaflet.js"></script>
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        var map = L.map('map', {minZoom: 0, maxZoom: 18}).setView([59.93, 30.34], 12);
        var markers = L.layerGroup().addTo(map);
        var selectedMarkerIds = [];
        var markerData = [];

        // –î–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫ (–∑–∞–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
        /* {{POINTS_DATA}} */

        var bridge = null;
        var colorChangeQueue = [];
        var colorChangeTimer = null;
        var currentLayer = null;
        var currentMode = 'offline';

        // CartoDB Voyager –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        var cartoDBVoyager = {
            online: {
                url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                options: {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    minZoom: 0, maxZoom: 18
                }
            }
        };

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ñ–ª–∞–π–Ω-—Å–ª–æ–π
        var OfflineTileLayer = L.TileLayer.extend({
            initialize: function(options) {
                L.TileLayer.prototype.initialize.call(this, '', options);
                this._tileCache = {};
            },

            createTile: function (coords, done) {
                var tile = L.DomUtil.create('canvas', 'leaflet-tile');
                var ctx = tile.getContext('2d');
                var size = this.getTileSize();
                tile.width = size.x;
                tile.height = size.y;

                var url = this.getTileUrl(coords);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–Ω–∞—á–∞–ª–∞
                if (this._tileCache[url]) {
                    var img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        done(null, tile);
                    };
                    img.src = this._tileCache[url];
                    return tile;
                }

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–∞–π–ª —á–µ—Ä–µ–∑ bridge
                if (window.bridge) {
                    window.bridge.getTile(url).then(function(dataUrl) {
                        if (dataUrl && dataUrl.startsWith('data:')) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                            this._tileCache[url] = dataUrl;

                            var img = new Image();
                            img.onload = function() {
                                ctx.drawImage(img, 0, 0);
                                done(null, tile);
                            };
                            img.onerror = function() {
                                showOfflineTile(tile, done);
                            };
                            img.src = dataUrl;
                        } else {
                            showOfflineTile(tile, done);
                        }
                    }.bind(this)).catch(function(error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–∞–π–ª–∞:', error);
                        showOfflineTile(tile, done);
                    });
                } else {
                    showOfflineTile(tile, done);
                }

                return tile;
            },

            _update: function() {
                this._tileCache = {};
                L.TileLayer.prototype._update.call(this);
            }
        });

        function showOfflineTile(tile, done) {
            var ctx = tile.getContext('2d');
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, 256, 256);
            ctx.fillStyle = '#6c757d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–û—Ñ–ª–∞–π–Ω', 128, 128);
            done(null, tile);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è CartoDB Voyager
        function getCartoDBTileUrl(coords) {
            var zoom = coords.z;
            var x = coords.x;
            var y = coords.y;

            // CartoDB Voyager URL pattern
            var subdomain = 'abcd'[Math.abs(x + y) % 4];
            return `https://${subdomain}.basemaps.cartocdn.com/rastertiles/voyager/${zoom}/${x}/${y}.png`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã
        function getCurrentBounds() {
            var bounds = map.getBounds();
            return {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ zoom —É—Ä–æ–≤–Ω—è
        function getCurrentZoom() {
            return map.getZoom();
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞—Ä—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü
        map.on('moveend', function() {
            updateMapBounds();
        });

        map.on('zoomend', function() {
            updateMapBounds();
        });

        function updateMapBounds() {
            var bounds = getCurrentBounds();
            var zoom = getCurrentZoom();
            // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Python –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            console.log("–ì—Ä–∞–Ω–∏—Ü—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã:", bounds, "Zoom:", zoom);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
        updateMapBounds();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebChannel
        if (typeof qt !== 'undefined') {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                bridge = channel.objects.bridge;
                console.log("WebChannel –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                initMap();
            });
        } else {
            console.error("WebChannel –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
            initMap();
        }

        function initMap() {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ
            switchToOfflineLayer();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ—á–∫–∏
            initPoints();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            setInterval(updateOnlineStatus, 1000);
        }

        function switchToOfflineLayer() {
            if (currentMode === 'offline') {
                console.log("–£–∂–µ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ");
                return;
            }

            console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º");

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // –°–æ–∑–¥–∞–µ–º –æ—Ñ–ª–∞–π–Ω-—Å–ª–æ–π —Å CartoDB Voyager URL pattern
            currentLayer = new OfflineTileLayer({
                attribution: 'CartoDB Voyager | –û—Ñ–ª–∞–π–Ω —Ç–∞–π–ª—ã –∏–∑ –∫—ç—à–∞',
                minZoom: 0,
                maxZoom: 20
            });

            // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è URL –¥–ª—è CartoDB
            currentLayer.getTileUrl = function(coords) {
                return getCartoDBTileUrl(coords);
            };

            currentLayer.addTo(map);
            currentMode = 'offline';
            updateOnlineStatus();

            // –£–≤–µ–¥–æ–º–ª—è–µ–º Python –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (bridge) {
                bridge.switchToOfflineMode();
            }

            console.log("–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º");
        }

        function switchToOnlineLayer() {
            if (currentMode === 'online') {
                console.log("–£–∂–µ –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
            if (!navigator.onLine) {
                alert("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º.");
                return;
            }

            console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º");

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // –°–æ–∑–¥–∞–µ–º –æ–Ω–ª–∞–π–Ω-—Å–ª–æ–π CartoDB Voyager
            currentLayer = L.tileLayer(
                cartoDBVoyager.online.url,
                cartoDBVoyager.online.options
            );

            currentLayer.addTo(map);
            currentMode = 'online';
            updateOnlineStatus();

            // –£–≤–µ–¥–æ–º–ª—è–µ–º Python –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (bridge) {
                bridge.switchToOnlineMode();
            }

            console.log("–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º");
        }

        function updateOnlineStatus() {
            var statusElement = document.getElementById('offline-status');

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
            if (currentMode === 'online') {
                statusElement.innerHTML = '‚óè CartoDB Voyager - –û–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º';
                statusElement.className = 'offline-status online';
            } else {
                statusElement.innerHTML = '‚óã CartoDB Voyager - –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
                statusElement.className = 'offline-status offline';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—á–µ–∫
        function initPoints() {
            if (typeof initialMarkerData !== 'undefined' && initialMarkerData.length > 0) {
                initialMarkerData.forEach(function(point, index) {
                    addMarker(
                        point.lat,
                        point.lng,
                        point.name,
                        point.id,
                        point.deep,
                        point.filters,
                        point.debit,
                        point.comments,
                        point.color,
                        point.fileName,
                        point.fileNames || []
                    );
                });
                initialMarkerData = [];

                updateNavTree();
                updateSelectedPointsList();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        function addMarker(lat, lng, name, id, deep, filters, debit, comments, color, fileName, fileNames) {
            if (!color) color = '#4361ee';

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ü–≤–µ—Ç–æ–º
            var markerIcon = L.divIcon({
                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}, 0 0 10px rgba(0,0,0,0.5);"></div>`,
                className: 'custom-marker',
                iconSize: [15, 15],
                iconAnchor: [7, 7]
            });

            var marker = L.marker([lat, lng], {icon: markerIcon}).addTo(markers);

            if (name) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ popup
                var fileCount = fileNames ? fileNames.length : (fileName ? 1 : 0);
                var popupContent = `<strong>${name}</strong>`;
                if (fileCount > 0) {
                    popupContent += `<br><small>–§–∞–π–ª–æ–≤: ${fileCount}</small>`;
                }
                marker.bindPopup(popupContent);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä–∞
            var markerInfo = {
                id: id,
                lat: lat,
                lng: lng,
                name: name,
                marker: marker,
                deep: deep,
                filters: filters,
                debit: debit,
                comments: comments,
                color: color,
                fileName: fileName || null,
                fileNames: fileNames || [],
                visible: true
            };

            markerData.push(markerInfo);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            marker.on('click', function() {
                showPointInfo(markerInfo);
                toggleMarkerSelection(markerInfo.id);
            });

            updateNavTree();
            return marker;
        }

        function removeSelectedPoints() {
           selectedMarkerIds.forEach(markerId => {
                const marker = markerData.find(m => m.id === markerId);
                if (marker) {
                    bridge.removePoint(marker.id);
                }
           });
        }

        function updateNavTree() {
            const navTree = document.getElementById('nav-tree');

            // –û—á–∏—â–∞–µ–º –¥–µ—Ä–µ–≤–æ
            navTree.innerHTML = '';

            if (markerData.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.textContent = '–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–µ—Ä–µ–≤–∞';
                emptyItem.classList.add('empty');
                navTree.appendChild(emptyItem);
            } else {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —Ü–≤–µ—Ç—É
                const groupedMarkers = {};
                markerData.forEach(marker => {
                    if (!groupedMarkers[marker.color]) {
                        groupedMarkers[marker.color] = [];
                    }
                    groupedMarkers[marker.color].push(marker);
                });

                // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞
                Object.keys(groupedMarkers).forEach(color => {
                    const groupMarkers = groupedMarkers[color];

                    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'group-header';

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
                    const totalFiles = groupMarkers.reduce((sum, marker) => sum + (marker.fileNames ? marker.fileNames.length : 0), 0);

                    groupHeader.innerHTML = `
                        <div class="group-title">
                            <span style="color: ${color}">‚óè</span>
                            <span>–¶–≤–µ—Ç: ${color}</span>
                            <span style="margin-left: 8px; color: #777; font-size: 12px;">
                                (${groupMarkers.length} —Ç–æ—á–µ–∫, ${totalFiles} —Ñ–∞–π–ª–æ–≤)
                            </span>
                        </div>
                        <div class="group-toggle">
                            <button class="icon-btn toggle-group" data-color="${color}">
                                ‚ñº
                            </button>
                            <button class="icon-btn toggle-group-visibility" data-color="${color}">
                                üëÅ
                            </button>
                        </div>
                    `;

                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –≥—Ä—É–ø–ø—ã
                    const groupContent = document.createElement('div');
                    groupContent.className = 'group-content';
                    groupContent.id = `group-${color.replace('#', '')}`;

                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤ –≥—Ä—É–ø–ø—É
                    groupMarkers.forEach(function(marker, index) {
                        const listItem = document.createElement('li');
                        if (selectedMarkerIds.includes(marker.id)) {
                            listItem.classList.add('selected');
                        }

                        if (!marker.visible) {
                            listItem.style.opacity = '0.5';
                        }

                        const colorBox = document.createElement('div');
                        colorBox.classList.add('marker-color');
                        colorBox.style.backgroundColor = marker.color;

                        const markerInfo = document.createElement('div');
                        markerInfo.classList.add('marker-info');

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ—á–∫–∏
                        const fileCount = marker.fileNames ? marker.fileNames.length : 0;
                        markerInfo.innerHTML = `
                            <span>${marker.name}</span>
                            ${fileCount > 0 ? `<span class="file-count">${fileCount}</span>` : ''}
                        `;
                        markerInfo.title = marker.name + (fileCount > 0 ? ` (${fileCount} —Ñ–∞–π–ª–æ–≤)` : '');

                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–º—ã–∫–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ä–∫–µ—Ä–∞
                        markerInfo.onclick = (function(marker) {
                            return function() {
                                showPointInfo(marker);
                                toggleMarkerSelection(marker.id);
                                map.panTo(marker.marker.getLatLng());
                                marker.marker.openPopup();
                            };
                        })(marker);

                        const visibilityBtn = document.createElement('button');
                        visibilityBtn.className = 'icon-btn';
                        visibilityBtn.innerHTML = marker.visible ? 'üëÅ' : 'üëÅ‚Äçüó®';
                        visibilityBtn.title = marker.visible ? '–°–∫—Ä—ã—Ç—å —Ç–æ—á–∫—É' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É';
                        visibilityBtn.onclick = (function(marker) {
                            return function(e) {
                                e.stopPropagation();
                                toggleMarkerVisibility(marker.id);
                            };
                        })(marker);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.classList.add('delete-btn');
                        deleteBtn.innerHTML = 'üóë';
                        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É';
                        deleteBtn.onclick = (function(markerId) {
                            return function(e) {
                                e.stopPropagation();
                                if (bridge) {
                                    bridge.removePoint(markerId);
                                }
                            };
                        })(marker.id);

                        listItem.appendChild(colorBox);
                        listItem.appendChild(markerInfo);
                        listItem.appendChild(visibilityBtn);
                        listItem.appendChild(deleteBtn);

                        groupContent.appendChild(listItem);
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –≤ –¥–µ—Ä–µ–≤–æ
                    navTree.appendChild(groupHeader);
                    navTree.appendChild(groupContent);

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã
                    const toggleBtn = groupHeader.querySelector('.toggle-group');
                    const visibilityBtn = groupHeader.querySelector('.toggle-group-visibility');

                    toggleBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const groupId = this.getAttribute('data-color');
                        const content = document.getElementById(`group-${groupId.replace('#', '')}`);
                        const icon = this;

                        if (content.classList.contains('expanded')) {
                            content.classList.remove('expanded');
                            icon.innerHTML = '‚ñº';
                        } else {
                            content.classList.add('expanded');
                            icon.innerHTML = '‚ñ≤';
                        }
                    });

                    visibilityBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const groupId = this.getAttribute('data-color');
                        const groupMarkers = groupedMarkers[groupId];
                        const allVisible = groupMarkers.every(m => m.visible);

                        groupMarkers.forEach(marker => {
                            marker.visible = !allVisible;
                            setMarkerVisibility(marker.id, marker.visible);
                        });

                        updateNavTree();
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä—É–ø–ø—ã (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å)
                    groupHeader.addEventListener('click', function(e) {
                        if (!e.target.closest('.group-toggle')) {
                            const groupId = color.replace('#', '');
                            const content = document.getElementById(`group-${groupId}`);
                            const icon = this.querySelector('.toggle-group');

                            if (content.classList.contains('expanded')) {
                                content.classList.remove('expanded');
                                icon.innerHTML = '‚ñº';
                            } else {
                                content.classList.add('expanded');
                                icon.innerHTML = '‚ñ≤';
                            }
                        }
                    });
                });
            }
        }

        function updateSelectedPointsList() {
            const selectedList = document.getElementById('selected-points-list');

            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            selectedList.innerHTML = '';

            if (selectedMarkerIds.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.textContent = '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫';
                emptyItem.classList.add('empty');
                selectedList.appendChild(emptyItem);
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –≤ —Å–ø–∏—Å–æ–∫
                selectedMarkerIds.forEach(markerId => {
                    const marker = markerData.find(m => m.id === markerId);
                    if (marker) {
                        const listItem = document.createElement('div');
                        listItem.className = 'selected-point-item';

                        const pointName = document.createElement('div');
                        pointName.className = 'selected-point-name';

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ—á–∫–∏
                        const fileCount = marker.fileNames ? marker.fileNames.length : 0;
                        pointName.innerHTML = `
                            <span>${marker.name}</span>
                            ${fileCount > 0 ? `<span class="file-count">${fileCount}</span>` : ''}
                        `;
                        pointName.title = marker.name + (fileCount > 0 ? ` (${fileCount} —Ñ–∞–π–ª–æ–≤)` : '');

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-selected-btn';
                        removeBtn.innerHTML = '‚úó';
                        removeBtn.title = '–£–±—Ä–∞—Ç—å –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö';
                        removeBtn.onclick = (function(markerId) {
                            return function() {
                                toggleMarkerSelection(markerId);
                            };
                        })(marker.id);

                         pointName.onclick = (function(marker) {
                            return function() {
                                map.panTo(marker.marker.getLatLng());
                                marker.marker.openPopup();
                            };
                        })(marker);

                        listItem.appendChild(pointName);
                        listItem.appendChild(removeBtn);
                        selectedList.appendChild(listItem);
                    }
                });
            }
        }

        function showPointInfo(marker) {
            const pointInfo = document.getElementById('point-info');

            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö
            let fileHtml = '';
            const files = marker.fileNames || [];

            if (files.length > 0) {
                fileHtml = `
                    <p><strong>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (${files.length}):</strong></p>
                    <div class="files-list">
                        ${files.map(fileName => `
                            <div class="file-item">
                                <span class="file-name" title="${fileName}">${fileName}</span>
                                <span class="file-link" onclick="openFile('${fileName}')">
                                    üìé
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="file-info">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ —Ñ–∞–π–ª–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ Word</p>
                `;
            } else {
                fileHtml = '<p><strong>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</strong> –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
            }

            pointInfo.innerHTML = `
                <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${marker.name}</p>
                <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}</p>
                <p><strong>–ì–ª—É–±–∏–Ω–∞:</strong> ${marker.deep}</p>
                <p><strong>–§–∏–ª—å—Ç—Ä—ã:</strong> ${marker.filters}</p>
                <p><strong>–î–µ–±–∏—Ç:</strong> ${marker.debit}</p>
                <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong> ${marker.comments}</p>
                ${fileHtml}
                <p><strong>–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞:</strong> <span style="color:${marker.color}">${marker.color}</span></p>
            `;
        }

        function openFile(fileName) {
            if (bridge && typeof bridge.openFileInWord === 'function') {
                bridge.openFileInWord(fileName);
            } else {
                console.error("–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª. –§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
            }
        }

        function toggleMarkerSelection(markerId) {
            const index = selectedMarkerIds.indexOf(markerId);
            if (index === -1) {
                selectedMarkerIds.push(markerId);
            } else {
                selectedMarkerIds.splice(index, 1);
            }
            updateNavTree();
            updateSelectedPointsList();
        }

        function selectAllMarkers() {
            selectedMarkerIds = markerData.map(marker => marker.id);
            updateNavTree();
            updateSelectedPointsList();
        }

        function deselectAllMarkers() {
            selectedMarkerIds = [];
            updateNavTree();
            updateSelectedPointsList();
        }

        function setMarkerVisibility(markerId, visible) {
            const markerInfo = markerData.find(m => m.id === markerId);
            if (markerInfo) {
                markerInfo.visible = visible;
                if (visible) {
                    markerInfo.marker.addTo(map);
                } else {
                    map.removeLayer(markerInfo.marker);
                }
            }
        }

        function toggleMarkerVisibility(markerId) {
            const markerInfo = markerData.find(m => m.id === markerId);
            if (markerInfo) {
                markerInfo.visible = !markerInfo.visible;
                setMarkerVisibility(markerId, markerInfo.visible);
                updateNavTree();
            }
        }

        function hideAllMarkers() {
            markerData.forEach(marker => {
                marker.visible = false;
                setMarkerVisibility(marker.id, false);
            });
            updateNavTree();
        }

        function showAllMarkers() {
            markerData.forEach(marker => {
                marker.visible = true;
                setMarkerVisibility(marker.id, true);
            });
            updateNavTree();
        }

        function hideSelectedMarkers() {
            selectedMarkerIds.forEach(id => {
                const markerInfo = markerData.find(m => m.id === id);
                if (markerInfo) {
                    markerInfo.visible = false;
                    setMarkerVisibility(id, false);
                }
            });
            updateNavTree();
        }

        function showSelectedMarkers() {
            selectedMarkerIds.forEach(id => {
                const markerInfo = markerData.find(m => m.id === id);
                if (markerInfo) {
                    markerInfo.visible = true;
                    setMarkerVisibility(id, true);
                }
            });
            updateNavTree();
        }

        function changeMarkerColor(color) {
            if (selectedMarkerIds.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫–µ—Ä—ã, –Ω–∞–∂–∞–≤ –Ω–∞ –Ω–∏—Ö –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            selectedMarkerIds.forEach(function(markerId) {
                const markerInfo = markerData.find(m => m.id === markerId);
                if (markerInfo) {
                    markerInfo.color = color;

                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–∫–æ–Ω–∫—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ü–≤–µ—Ç–æ–º
                    var newIcon = L.divIcon({
                        html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}, 0 0 10px rgba(0,0,0,0.5);"></div>`,
                        className: 'custom-marker',
                        iconSize: [15, 15],
                        iconAnchor: [7, 7]
                    });

                    markerInfo.marker.setIcon(newIcon);
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            colorChangeQueue.push({color: color, markerIds: [...selectedMarkerIds]});

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–¥–µ–±–∞—É–Ω—Å–∏–Ω–≥)
            if (colorChangeTimer) clearTimeout(colorChangeTimer);
            colorChangeTimer = setTimeout(sendColorUpdates, 1000);

            updateNavTree();
        }

        function sendColorUpdates() {
            if (colorChangeQueue.length === 0 || !bridge) return;

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
            const latestColors = {};
            colorChangeQueue.forEach(change => {
                change.markerIds.forEach(id => {
                    latestColors[id] = change.color;
                });
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä–æ–≤
            markerData.forEach(marker => {
                if (latestColors[marker.id]) {
                    marker.color = latestColors[marker.id];
                }
            });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
            const dataToSend = markerData.map(marker => ({
                id: marker.id,
                lat: marker.lat,
                lng: marker.lng,
                name: marker.name,
                deep: marker.deep,
                filters: marker.filters,
                debit: marker.debit,
                comments: marker.comments,
                color: marker.color,
                fileName: marker.fileName,  // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                fileNames: marker.fileNames  // –ú–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤
            }));

            bridge.changeColor(JSON.stringify(dataToSend));
            colorChangeQueue = [];
        }

        function removeMarker(id) {
            const index = markerData.findIndex(m => m.id === id);
            if (index !== -1) {
                map.removeLayer(markerData[index].marker);
                markerData.splice(index, 1);

                // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å
                const selectedIndex = selectedMarkerIds.indexOf(id);
                if (selectedIndex !== -1) {
                    selectedMarkerIds.splice(selectedIndex, 1);
                }

                updateNavTree();
                updateSelectedPointsList();
                document.getElementById('point-info').innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ';
            }
        }

        function enableClickHandler() {
            map.on('click', function(e) {
                if (bridge) {
                    bridge.addPoint(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        function disableClickHandler() {
            map.off('click');
        }

        function searchPoints() {
            hideAllMarkers()
            const searchText = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results');

            if (!searchText) {
                resultsContainer.style.display = 'none';
                return;
            }

            // –ò—â–µ–º —Ç–æ—á–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞ –≤ –ª—é–±–æ–º –ø–æ–ª–µ
            const results = markerData.filter(marker =>
                (marker.name && marker.name.toLowerCase().includes(searchText)) ||
                (marker.deep && marker.deep.toLowerCase().includes(searchText)) ||
                (marker.filters && marker.filters.toLowerCase().includes(searchText)) ||
                (marker.debit && marker.debit.toLowerCase().includes(searchText)) ||
                (marker.comments && marker.comments.toLowerCase().includes(searchText)) ||
                (marker.fileName && marker.fileName.toLowerCase().includes(searchText)) ||
                (marker.fileNames && marker.fileNames.some(fileName => fileName.toLowerCase().includes(searchText)))
            );

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                resultsContainer.innerHTML = '';
                results.forEach(marker => {
                    toggleMarkerVisibility(marker.id)
                    const fileCount = marker.fileNames ? marker.fileNames.length : 0;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div>${marker.name}</div>
                        <small style="color: #666;">–§–∞–π–ª–æ–≤: ${fileCount}</small>
                    `;

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ç–æ—á–∫–µ
                    resultItem.addEventListener('click', function() {
                        showPointInfo(marker);
                        toggleMarkerSelection(marker.id);
                        map.panTo(marker.marker.getLatLng());
                        marker.marker.openPopup();

                        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
                        resultsContainer.style.display = 'none';
                    });

                    resultsContainer.appendChild(resultItem);
                });
            }

            resultsContainer.style.display = 'block';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–º
        document.getElementById('apply-color').addEventListener('click', function() {
            const color = document.getElementById('marker-color').value;
            changeMarkerColor(color);
        });

        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –æ–ø—Ü–∏–π
        document.querySelector('.color-options').addEventListener('click', function(e) {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                const color = colorOption.getAttribute('data-color');
                document.getElementById('marker-color').value = color;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                document.querySelectorAll('.color-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                colorOption.classList.add('selected');
            }
        });

        document.getElementById('marker-color').addEventListener('change', function() {
            const color = this.value;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.color-option').forEach(function(opt) {
                opt.classList.remove('selected');
                if (opt.getAttribute('data-color') === color) {
                    opt.classList.add('selected');
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞
        document.getElementById('search-btn').addEventListener('click', searchPoints);

        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPoints();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é
        document.getElementById('hide-all-btn').addEventListener('click', hideAllMarkers);
        document.getElementById('show-all-btn').addEventListener('click', showAllMarkers);
        document.getElementById('hide-selected-btn').addEventListener('click', hideSelectedMarkers);
        document.getElementById('show-selected-btn').addEventListener('click', showSelectedMarkers);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
        document.getElementById('select-all-btn').addEventListener('click', selectAllMarkers);
        document.getElementById('deselect-all-btn').addEventListener('click', deselectAllMarkers);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞
        document.getElementById('toggle-nav-tree').addEventListener('click', function() {
            const content = document.getElementById('nav-tree-content');
            const icon = this;

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.innerHTML = '‚ñº';
            } else {
                content.classList.add('expanded');
                icon.innerHTML = '‚ñ≤';
            }
        });

        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–∏—Å–∫–∞
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            const searchResults = document.getElementById('search-results');

            if (!searchContainer.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        initPoints();
    </script>
</body>
</html>