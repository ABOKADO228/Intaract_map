<!DOCTYPE html>
<html>
<head>
    <title>Интерактивная карта</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        #web-content {
            display: flex;
            width: 100%;
            height: 97vh;
            justify-self: center;
            align-self: center;
        }
        #map {
            width: 75%;
        }
        #side-panel {
            width: 25%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        .nav-tree-container {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
        }
        .point-info-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
            flex-grow: 1;
        }
        .color-controls {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        .color-picker {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .color-picker label {
            margin-right: 10px;
            font-weight: bold;
        }
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border-color: #333;
        }
        #nav-tree {
            list-style-type: none;
            padding: 0;
        }
        #nav-tree li {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #4361ee;
        }
        .marker-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        .marker-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .empty {
            color: #777;
            font-style: italic;
        }
        h3 {
            margin-bottom: 10px;
            color: #333;
        }
        #point-info {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        #point-info p {
            margin: 8px 0;
        }
        #apply-color {
            margin-top: 10px;
            padding: 8px 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #apply-color:hover {
            background: #3a56d4;
        }
    </style>
</head>
<body>
    <div id="web-content">
        <div id="map"></div>
        <div id="side-panel">
            <div class="nav-tree-container">
                <div class="nav-tree-title">Элементы навигационного дерева:</div>
                <ul id="nav-tree">
                    <li class="empty">Добавьте маркеры, чтобы увидеть элементы дерева</li>
                </ul>
            </div>

            <div class="color-controls">
                <h3>Изменение цвета маркеров</h3>
                <div class="color-picker">
                    <label for="marker-color">Цвет маркера:</label>
                    <input type="color" id="marker-color" value="#4361ee">
                </div>
                <div class="color-options">
                    <div class="color-option selected" style="background-color: #4361ee;" data-color="#4361ee"></div>
                    <div class="color-option" style="background-color: #ff4757;" data-color="#ff4757"></div>
                    <div class="color-option" style="background-color: #2ed573;" data-color="#2ed573"></div>
                    <div class="color-option" style="background-color: #ffa502;" data-color="#ffa502"></div>
                    <div class="color-option" style="background-color: #a55eea;" data-color="#a55eea"></div>
                    <div class="color-option" style="background-color: #00d2d3;" data-color="#00d2d3"></div>
                </div>
                <button id="apply-color">Применить цвет к выбранным маркерам</button>
            </div>

            <div class="point-info-container">
                <h3>Информация о точке:</h3>
                <div id="point-info">Выберите точку на карте или в списке</div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script>
        // Инициализация карты
        var map = L.map('map').setView([59.93, 30.34], 12);
        var markers = L.layerGroup().addTo(map);
        var selectedMarkerIds = [];

        // Данные точек (заменяются при загрузке)
        /* {{POINTS_DATA}} */

        var bridge = null;
        var colorChangeQueue = [];
        var colorChangeTimer = null;

        // Инициализация WebChannel
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof qt !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    bridge = channel.objects.bridge;
                    console.log("WebChannel инициализирован");
                });
            } else {
                console.error("WebChannel не доступен");
            }
        });

        // Добавление слоя OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Инициализация точек
        function initPoints() {
            if (typeof markerData !== 'undefined' && markerData.length > 0) {
                // Используем фрагмент документа для быстрой вставки
                var tempContainer = document.createDocumentFragment();

                markerData.forEach(function(point, index) {
                    addMarkerInit(
                        point.lat,
                        point.lng,
                        point.name,
                        point.id,
                        point.deep,
                        point.filters,
                        point.debit,
                        point.comments,
                        point.color || '#4361ee'
                    );
                });

                updateNavTree();
            }
        }

        // Добавление маркера инициализации (универсальная функция)
        function addMarkerInit(lat, lng, name, id, deep, filters, debit, comments, color) {
            if (!color) color = '#4361ee';

            // Создаем кастомную иконку с выбранным цветом
            var markerIcon = L.divIcon({
                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}, 0 0 10px rgba(0,0,0,0.5);"></div>`,
                className: 'custom-marker',
                iconSize: [15, 15],
                iconAnchor: [7, 7]
            });

            var marker = L.marker([lat, lng], {icon: markerIcon}).addTo(markers);

            if (name) {
                marker.bindPopup(name);
            }

            // Сохраняем данные маркера
            var markerInfo = {
                id: id,
                lat: lat,
                lng: lng,
                name: name,
                marker: marker,
                deep: deep,
                filters: filters,
                debit: debit,
                comments: comments,
                color: color
            };

            // Добавляем обработчик клика для показа информации
            marker.on('click', function() {
                showPointInfo(markerInfo);
                toggleMarkerSelection(markerInfo.id);
            });

            return marker;
        }

        // Добавление маркера (универсальная функция)
        function addMarker(lat, lng, name, id, deep, filters, debit, comments, color) {
            if (!color) color = '#4361ee';

            // Создаем кастомную иконку с выбранным цветом
            var markerIcon = L.divIcon({
                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}, 0 0 10px rgba(0,0,0,0.5);"></div>`,
                className: 'custom-marker',
                iconSize: [15, 15],
                iconAnchor: [7, 7]
            });

            var marker = L.marker([lat, lng], {icon: markerIcon}).addTo(markers);

            if (name) {
                marker.bindPopup(name);
            }

            // Сохраняем данные маркера
            var markerInfo = {
                id: id,
                lat: lat,
                lng: lng,
                name: name,
                marker: marker,
                deep: deep,
                filters: filters,
                debit: debit,
                comments: comments,
                color: color
            };

            markerData.push(markerInfo);

            // Добавляем обработчик клика для показа информации
            marker.on('click', function() {
                showPointInfo(markerInfo);
                toggleMarkerSelection(markerInfo.id);
            });
            updateNavTree();
            return marker;
        }

        // Обновление навигационного дерева с использованием DocumentFragment
        function updateNavTree() {
            const navTree = document.getElementById('nav-tree');
            const fragment = document.createDocumentFragment();

            if (markerData.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.textContent = 'Добавьте маркеры, чтобы увидеть элементы дерева';
                emptyItem.classList.add('empty');
                fragment.appendChild(emptyItem);
            } else {
                markerData.forEach(function(marker, index) {
                    const newItem = document.createElement('li');
                    if (selectedMarkerIds.includes(marker.id)) {
                        newItem.style.backgroundColor = '#e6f0ff';
                    }

                    const colorBox = document.createElement('div');
                    colorBox.classList.add('marker-color');
                    colorBox.style.backgroundColor = marker.color;

                    const markerInfo = document.createElement('div');
                    markerInfo.classList.add('marker-info');
                    markerInfo.textContent = `${index+1}. ${marker.name}`;
                    markerInfo.onclick = function() {
                        showPointInfo(marker);
                        map.panTo(marker.marker.getLatLng());
                        marker.marker.openPopup();
                        toggleMarkerSelection(marker.id);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Удалить';
                    deleteBtn.classList.add('delete-btn');
                    deleteBtn.onclick = function() {
                        if (bridge) {
                            bridge.removePoint(marker.id);
                        }
                    };

                    newItem.appendChild(colorBox);
                    newItem.appendChild(markerInfo);
                    newItem.appendChild(deleteBtn);

                    fragment.appendChild(newItem);
                });
            }

            // Быстрая замена содержимого
            navTree.innerHTML = '';
            navTree.appendChild(fragment);
        }

        // Показать информацию о точке
        function showPointInfo(marker) {
            const pointInfo = document.getElementById('point-info');
            pointInfo.innerHTML = `
                <p><strong>Название:</strong> ${marker.name}</p>
                <p><strong>Координаты:</strong> ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}</p>
                <p><strong>Глубина:</strong> ${marker.deep}</p>
                <p><strong>Фильтры:</strong> ${marker.filters}</p>
                <p><strong>Дебит:</strong> ${marker.debit}</p>
                <p><strong>Комментарии:</strong> ${marker.comments}</p>
                <p><strong>Цвет маркера:</strong> <span style="color:${marker.color}">${marker.color}</span></p>
            `;
        }

        // Выбор/снятие выбора маркера
        function toggleMarkerSelection(markerId) {
            const index = selectedMarkerIds.indexOf(markerId);
            if (index === -1) {
                selectedMarkerIds.push(markerId);
            } else {
                selectedMarkerIds.splice(index, 1);
            }
            updateNavTree();
        }

        // Изменение цвета маркеров с оптимизацией
        function changeMarkerColor(color) {
            if (selectedMarkerIds.length === 0) {
                alert('Сначала выберите маркеры, нажав на них в списке или на карте');
                return;
            }

            // Обновляем только выбранные маркеры
            selectedMarkerIds.forEach(function(markerId) {
                const markerInfo = markerData.find(m => m.id === markerId);
                if (markerInfo) {
                    markerInfo.color = color;

                    // Создаем новую иконку с обновленным цветом
                    var newIcon = L.divIcon({
                        html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}, 0 0 10px rgba(0,0,0,0.5);"></div>`,
                        className: 'custom-marker',
                        iconSize: [15, 15],
                        iconAnchor: [7, 7]
                    });

                    markerInfo.marker.setIcon(newIcon);
                }
            });

            // Добавляем в очередь обновлений
            colorChangeQueue.push({color: color, markerIds: [...selectedMarkerIds]});

            // Запускаем таймер для отправки изменений (дебаунсинг)
            if (colorChangeTimer) clearTimeout(colorChangeTimer);
            colorChangeTimer = setTimeout(sendColorUpdates, 1000);

            updateNavTree();
        }

        // Отправка обновлений цветов с дебаунсингом
        function sendColorUpdates() {
            if (colorChangeQueue.length === 0 || !bridge) return;

            // Создаем карту последних цветов для каждого маркера
            const latestColors = {};
            colorChangeQueue.forEach(change => {
                change.markerIds.forEach(id => {
                    latestColors[id] = change.color;
                });
            });

            // Обновляем данные маркеров
            markerData.forEach(marker => {
                if (latestColors[marker.id]) {
                    marker.color = latestColors[marker.id];
                }
            });

            // Отправляем только необходимые данные
            const dataToSend = markerData.map(marker => ({
                id: marker.id,
                lat: marker.lat,
                lng: marker.lng,
                name: marker.name,
                deep: marker.deep,
                filters: marker.filters,
                debit: marker.debit,
                comments: marker.comments,
                color: marker.color
            }));

            bridge.changeColor(JSON.stringify(dataToSend));
            colorChangeQueue = [];
        }

        // Удаление маркера
        function removeMarker(id) {
            const index = markerData.findIndex(m => m.id === id);
            if (index !== -1) {
                markers.removeLayer(markerData[index].marker);
                markerData.splice(index, 1);

                // Удаляем из выбранных, если есть
                const selectedIndex = selectedMarkerIds.indexOf(id);
                if (selectedIndex !== -1) {
                    selectedMarkerIds.splice(selectedIndex, 1);
                }

                updateNavTree();
                document.getElementById('point-info').innerHTML = 'Выберите точку на карте или в списке';
            }
        }

        // Очистка всех маркеров
        function clearMarkers() {
            markers.clearLayers();
            markerData = [];
            selectedMarkerIds = [];
            updateNavTree();
            document.getElementById('point-info').innerHTML = 'Выберите точку на карте или в списке';
        }

        // Включение обработчика кликов
        function enableClickHandler() {
            map.on('click', function(e) {
                if (bridge) {
                    bridge.addPoint(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // Отключение обработчика кликов
        function disableClickHandler() {
            map.off('click');
        }

        // Обработчики событий для элементов управления цветом
        document.getElementById('apply-color').addEventListener('click', function() {
            const color = document.getElementById('marker-color').value;
            changeMarkerColor(color);
        });

        // Делегирование событий для цветовых опций
        document.querySelector('.color-options').addEventListener('click', function(e) {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                const color = colorOption.getAttribute('data-color');
                document.getElementById('marker-color').value = color;

                // Обновляем визуальное выделение
                document.querySelectorAll('.color-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                colorOption.classList.add('selected');
            }
        });

        document.getElementById('marker-color').addEventListener('change', function() {
            const color = this.value;

            // Обновляем визуальное выделение
            document.querySelectorAll('.color-option').forEach(function(opt) {
                opt.classList.remove('selected');
                if (opt.getAttribute('data-color') === color) {
                    opt.classList.add('selected');
                }
            });
        });
    </script>
</body>
</html>