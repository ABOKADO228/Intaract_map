
<!DOCTYPE html>
<html>
<head>
    <title>Интерактивная карта</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
    }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Важно: добавляем скрипт qwebchannel.js -->
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <script>
        // Инициализация карты
        var map = L.map('map').setView([55.7558, 37.6173], 12); // Москва по умолчанию

        var markers = L.layerGroup().addTo(map);
        var bridge = null; // Объект для связи с Python

        // Инициализация WebChannel после загрузки страницы
        document.addEventListener("DOMContentLoaded", function() {
            // Проверяем, доступен ли WebChannel
            if (typeof qt !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    bridge = channel.objects.bridge;
                    console.log("WebChannel инициализирован");
                });
            } else {
                console.error("WebChannel не доступен");
            }
        });

        // Добавление слоя OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Добавление маркера
        function addMarker(lat, lng, name) {
            var marker = L.marker([lat, lng]);
            if (name) {
                marker.addTo(markers);
                marker.bindPopup(name).openPopup();
            }
            return marker;
        }

        // Очистка всех маркеров
        function clearMarkers() {
            markers.clearLayers();
        }

        // Включение обработчика кликов
        function enableClickHandler() {
            map.on('click', function(e) {
                console.log("Клик на карте: ", e.latlng);
                // Передаем координаты в приложение
                if (bridge) {
                    bridge.addPoint(e.latlng.lat, e.latlng.lng);
                } else {
                    console.error("Объект bridge не инициализирован");
                }
            });
            console.log("Обработчик кликов активирован");
        }

        // Отключение обработчика кликов
        function disableClickHandler() {
            map.off('click');
            console.log("Обработчик кликов деактивирован");
        }
    </script>
</body>
</html>
        